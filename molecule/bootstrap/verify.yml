---
- name: Verify bootstrap deployment
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Verify Docker is running
      ansible.builtin.command: docker ps
      register: docker_status
      changed_when: false

    - name: Display Docker status
      ansible.builtin.debug:
        var: docker_status.stdout

    - name: Verify Docker Compose is installed
      ansible.builtin.command: docker compose version
      register: compose_version
      changed_when: false

    - name: Display Docker Compose version
      ansible.builtin.debug:
        var: compose_version.stdout

    - name: Verify playbooks exist
      ansible.builtin.stat:
        path: "{{ item }}"
      register: playbook_check
      loop:
        - /opt/infrastructure/playbooks/docker-bootstrap.yml
        - /opt/infrastructure/playbooks/docker-check-health.yml

    - name: Display playbook check results
      ansible.builtin.debug:
        msg: "Playbook {{ item.item }} exists: {{ item.stat.exists }}"
      loop: "{{ playbook_check.results }}"

    - name: Assert playbooks exist
      ansible.builtin.assert:
        that:
          - item.stat.exists
        fail_msg: "Required playbook not found: {{ item.item }}"
      loop: "{{ playbook_check.results }}"

    - name: Verify Makefile has new targets
      ansible.builtin.shell: grep -E "docker-bootstrap|docker-check-health" /opt/infrastructure/Makefile
      register: makefile_check
      changed_when: false

    - name: Display Makefile check results
      ansible.builtin.debug:
        var: makefile_check.stdout_lines

    - name: Verify YAML syntax of playbooks
      ansible.builtin.command: yamllint "{{ item }}"
      loop:
        - /opt/infrastructure/playbooks/docker-bootstrap.yml
        - /opt/infrastructure/playbooks/docker-check-health.yml
      register: yaml_check
      changed_when: false

    - name: Display YAML syntax check
      ansible.builtin.debug:
        msg: "YAML syntax valid"

    - name: Verify Ansible lint compliance
      ansible.builtin.shell: ansible-lint /opt/infrastructure/playbooks/docker-bootstrap.yml /opt/infrastructure/playbooks/docker-check-health.yml
      register: lint_check
      changed_when: false
      ignore_errors: true

    - name: Display Ansible lint results
      ansible.builtin.debug:
        msg: "Linting completed (check output for any issues)"
