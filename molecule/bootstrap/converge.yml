---
- name: Converge - Test bootstrap deployment and reset
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Determine infrastructure project root
      ansible.builtin.set_fact:
        infrastructure_root: "/opt/infrastructure"

    - name: Show infrastructure project root
      ansible.builtin.debug:
        var: infrastructure_root

    - name: Create inventory for bootstrap test
      ansible.builtin.copy:
        dest: /tmp/bootstrap_inventory.yml
        content: |
          all:
            children:
              homelab:
                hosts:
                  localhost:
                    ansible_connection: local
                    ansible_host: localhost
                    ansible_python_interpreter: "{{ ansible_python.executable }}"
        mode: '0644'

    - name: Create bootstrap extra vars file
      ansible.builtin.copy:
        dest: /tmp/bootstrap_vars.yml
        content: |
          stacks_src_dir: /tmp/stacks
          stacks_dir: /tmp/stacks
          ansible_date_time:
            iso8601: "2025-01-01T00:00:00Z"
        mode: '0644'

    # ==========================================================================
    # Test 1: Zitadel Reset Playbook
    # ==========================================================================

    - name: Verify pre-reset state - PAT file exists
      ansible.builtin.stat:
        path: /tmp/stacks/zitadel/config/login-client.pat
      register: pat_before_reset

    - name: Assert PAT file exists before reset
      ansible.builtin.assert:
        that: pat_before_reset.stat.exists
        fail_msg: "PAT file should exist before reset"

    - name: Verify pre-reset state - .env file exists
      ansible.builtin.stat:
        path: /tmp/stacks/.env
      register: env_file_stat

    - name: Assert .env file exists before reset
      ansible.builtin.assert:
        that: env_file_stat.stat.exists
        fail_msg: ".env file should exist before reset"

    - name: Verify pre-reset state - .env has ZITADEL_COMMAND=start
      ansible.builtin.shell: grep "ZITADEL_COMMAND=start" /tmp/stacks/.env
      register: env_before_reset
      changed_when: false

    - name: Assert ZITADEL_COMMAND=start is present before reset
      ansible.builtin.assert:
        that: env_before_reset.rc == 0
        fail_msg: "ZITADEL_COMMAND=start should be present in .env before reset"

    - name: Run zitadel-reset playbook
      ansible.builtin.shell: |
        cd /tmp
        ansible-playbook -i bootstrap_inventory.yml \
          -e stacks_dir=/tmp/stacks \
          -e skip_confirmation=true \
          "{{ infrastructure_root }}/playbooks/zitadel-reset.yml"
      args:
        executable: /bin/bash
      environment:
        ANSIBLE_HOST_KEY_CHECKING: "False"
      register: reset_result
      changed_when: false
      failed_when: reset_result.rc != 0

    - name: Display reset result
      ansible.builtin.debug:
        var: reset_result.stdout_lines

    - name: Verify post-reset state - PAT file removed
      ansible.builtin.stat:
        path: /tmp/stacks/zitadel/config/login-client.pat
      register: pat_after_reset

    - name: Assert PAT file was removed
      ansible.builtin.assert:
        that: not pat_after_reset.stat.exists
        fail_msg: "PAT file should be removed after reset"

    - name: Verify post-reset state - .env has ZITADEL_COMMAND=start-from-init
      ansible.builtin.shell: grep "ZITADEL_COMMAND=start-from-init" /tmp/stacks/.env
      register: env_after_reset
      changed_when: false

    - name: Assert ZITADEL_COMMAND was updated
      ansible.builtin.assert:
        that: env_after_reset.rc == 0
        fail_msg: "ZITADEL_COMMAND should be set to start-from-init after reset"

    - name: Verify post-reset state - ZITADEL_FIRSTINSTANCE_SKIP=false
      ansible.builtin.shell: grep "ZITADEL_FIRSTINSTANCE_SKIP=false" /tmp/stacks/.env
      register: skip_after_reset
      changed_when: false

    - name: Assert ZITADEL_FIRSTINSTANCE_SKIP was updated
      ansible.builtin.assert:
        that: skip_after_reset.rc == 0
        fail_msg: "ZITADEL_FIRSTINSTANCE_SKIP should be set to false after reset"

    - name: Check docker stub state files exist
      ansible.builtin.stat:
        path: "{{ item }}"
      register: stub_state_files
      loop:
        - /tmp/docker-stub-state/containers
        - /tmp/docker-stub-state/volumes

    - name: Assert docker stub state files exist
      ansible.builtin.assert:
        that: item.stat.exists
        fail_msg: "Docker stub state file should exist: {{ item.item }}"
      loop: "{{ stub_state_files.results }}"

    - name: Verify post-reset state - containers removed from stub state
      ansible.builtin.shell: cat /tmp/docker-stub-state/containers
      register: containers_after_reset
      changed_when: false

    - name: Assert zitadel containers were removed
      ansible.builtin.assert:
        that:
          - "'zitadel' not in containers_after_reset.stdout"
          - "'zitadel-login' not in containers_after_reset.stdout"
          - "'zitadel-db' not in containers_after_reset.stdout"
        fail_msg: "Zitadel containers should be removed from state after reset"

    - name: Verify post-reset state - volume removed from stub state
      ansible.builtin.shell: cat /tmp/docker-stub-state/volumes
      register: volumes_after_reset
      changed_when: false

    - name: Assert zitadel volume was removed
      ansible.builtin.assert:
        that: "'zitadel' not in volumes_after_reset.stdout"
        fail_msg: "Zitadel volume should be removed from state after reset"

    # ==========================================================================
    # Test 2: Bootstrap Deploy Playbook (syntax validation only)
    # ==========================================================================

    - name: Run staged bootstrap deploy playbook
      ansible.builtin.shell: |
        cd /tmp
        ansible-playbook -i bootstrap_inventory.yml \
          -e docker_skip_compose=true \
          "{{ infrastructure_root }}/playbooks/docker-deploy-bootstrap.yml"
      args:
        executable: /bin/bash
      environment:
        ANSIBLE_HOST_KEY_CHECKING: "False"
      register: bootstrap_deploy
      changed_when: false
      failed_when: bootstrap_deploy.rc != 0

    - name: Display bootstrap deploy result
      ansible.builtin.debug:
        var: bootstrap_deploy.stdout_lines

    # Note: Health check playbook requires real docker JSON output which
    # the stub doesn't provide. Health check is tested separately.
