---
- name: Deploy bootstrap stacks (socket proxy + Zitadel)
  hosts: homelab
  become: true
  gather_facts: false

  vars:
    stacks_src_dir: "{{ ([playbook_dir, '..', 'stacks'] | path_join) | realpath }}"
    stacks_dest_dir: "/opt/stacks"
    required_networks:
      - traefik
      - socket-proxy
    bootstrap_containers:
      - docker-socket-proxy
      - zitadel-db
      - zitadel
      - zitadel-login
    enable_zitadel_oidc_setup: "{{ not (docker_skip_compose | default(false)) }}"
    enable_zitadel_login_wait: "{{ not (docker_skip_compose | default(false)) }}"

  tasks:
    - name: Ensure rsync is available on remote host
      ansible.builtin.package:
        name: rsync
        state: present

    - name: Ensure stacks directory exists on remote host
      ansible.builtin.file:
        path: "{{ stacks_dest_dir }}"
        state: directory
        mode: "0755"

    - name: Sync stacks directory (including bootstrap orchestrator) to remote host
      ansible.posix.synchronize:
        src: "{{ stacks_src_dir }}/"
        dest: "{{ stacks_dest_dir }}/"
        delete: false
        recursive: true
        rsync_opts:
          - "--perms"
          - "--times"
          - "--omit-dir-times"
        use_ssh_args: true
        rsync_path: "sudo rsync"
      delegate_to: localhost
      become: false

    - name: Ensure shared networks exist for bootstrap stage
      community.docker.docker_network:
        name: "{{ item }}"
        state: present
      loop: "{{ required_networks }}"

    - name: Ensure Zitadel config directory is owned by container user
      ansible.builtin.file:
        path: "{{ stacks_dest_dir }}/zitadel/config"
        state: directory
        owner: "1000"
        group: "1000"
        mode: "0755"
        recurse: true

    - name: Deploy bootstrap compose project (root-level orchestrator)
      community.docker.docker_compose_v2:
        project_src: "{{ stacks_dest_dir }}"
        project_name: bootstrap
        files:
          - docker-compose.bootstrap.yml
        state: present
        pull: always
      when:
        - not (docker_skip_compose | default(false))
        - not (ansible_check_mode | default(false))

    - name: Wait for bootstrap containers to be running
      ansible.builtin.command: >-
        docker inspect -f '{% raw %}{{ .State.Running }}{% endraw %}' {{ item }}
      register: container_status
      changed_when: false
      until: container_status.stdout | trim == 'true'
      retries: 30
      delay: 5
      loop: "{{ bootstrap_containers }}"
      when: not (ansible_check_mode | default(false))

    - name: Wait for Zitadel v2 login UI endpoint
      ansible.builtin.uri:
        url: "https://{{ lookup('env', 'ZITADEL_PUBLIC_DOMAIN') | default('login.rzp.one', true) }}/ui/v2/login"
        method: GET
        validate_certs: false
        status_code: 200
      register: zitadel_login
      retries: 20
      delay: 5
      until: zitadel_login is succeeded
      ignore_errors: true
      when:
        - enable_zitadel_login_wait | bool
        - not (ansible_check_mode | default(false))

    - name: Report bootstrap deployment result
      ansible.builtin.debug:
        msg: "Bootstrap stacks deployed successfully"
