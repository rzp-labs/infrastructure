---
- name: Automate Zitadel application setup
  hosts: homelab
  become: true
  gather_facts: false
  strategy: linear

  vars:
    stacks_dest_dir: "/opt/stacks"
    # Expect the operator to provide:
    # - zitadel_setup_public_domain: external Zitadel domain (e.g. auth.example.com)
    # - zitadel_setup_project_name: target project to manage or create
    # - zitadel_setup_oidc_apps: list of app mappings with redirect URIs and optional env updates

  pre_tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - zitadel_setup_public_domain is defined and zitadel_setup_public_domain | length > 0
          - zitadel_setup_project_name is defined and zitadel_setup_project_name | length > 0
          - zitadel_setup_oidc_apps is defined
          - zitadel_setup_oidc_apps | length > 0
        fail_msg: |
          Provide zitadel_setup_public_domain, zitadel_setup_project_name, and a non-empty zitadel_setup_oidc_apps list.

    - name: Ensure Zitadel login client PAT exists
      ansible.builtin.stat:
        path: "{{ stacks_dest_dir }}/zitadel/config/login-client.pat"
      register: zitadel_pat_file

    - name: Fail if Zitadel login client PAT is missing
      ansible.builtin.fail:
        msg: "login-client.pat not found at {{ stacks_dest_dir }}/zitadel/config/login-client.pat. Deploy Zitadel first."
      when: not zitadel_pat_file.stat.exists

    - name: Read Zitadel login client PAT
      ansible.builtin.slurp:
        path: "{{ stacks_dest_dir }}/zitadel/config/login-client.pat"
      register: zitadel_pat_slurp

    - name: Store Zitadel login client PAT value
      ansible.builtin.set_fact:
        zitadel_setup_pat: "{{ zitadel_pat_slurp.content | b64decode | trim }}"

    - name: Define Zitadel management API base URL
      ansible.builtin.set_fact:
        zitadel_setup_api_base: "https://{{ zitadel_setup_public_domain }}/management/v1"

    - name: Prepare application results list
      ansible.builtin.set_fact:
        zitadel_setup_results: []

  tasks:
    - name: Search for Zitadel project
      ansible.builtin.uri:
        url: "{{ zitadel_setup_api_base }}/projects/_search"
        method: POST
        headers:
          Authorization: "Bearer {{ zitadel_setup_pat }}"
        body_format: json
        body:
          limit: 1
          queries:
            - nameQuery:
                name: "{{ zitadel_setup_project_name }}"
                method: "TEXT_QUERY_METHOD_EQUALS"
        status_code: 200
        validate_certs: true
      register: zitadel_project_search
      delegate_to: localhost

    - name: Determine Zitadel project ID
      ansible.builtin.set_fact:
        zitadel_setup_project_id: "{{ (zitadel_project_search.json.result | default([]))[0].id | default('') }}"

    - name: Ensure Zitadel project exists when creation allowed
      when:
        - zitadel_setup_project_id | length == 0
        - zitadel_setup_create_project | default(false)
      block:
        - name: Create Zitadel project
          ansible.builtin.uri:
            url: "{{ zitadel_setup_api_base }}/projects"
            method: POST
            headers:
              Authorization: "Bearer {{ zitadel_setup_pat }}"
            body_format: json
            body:
              name: "{{ zitadel_setup_project_name }}"
            status_code: 200
            validate_certs: true
          register: zitadel_project_create
          delegate_to: localhost

        - name: Set Zitadel project ID after creation
          ansible.builtin.set_fact:
            zitadel_setup_project_id: "{{ zitadel_project_create.json.id }}"

    - name: Abort when Zitadel project not found
      ansible.builtin.fail:
        msg: "Project '{{ zitadel_setup_project_name }}' not found and automatic creation disabled."
      when:
        - zitadel_setup_project_id | default('') | length == 0

    - name: Manage Zitadel OIDC applications
      ansible.builtin.include_tasks: tasks/zitadel_setup_manage_oidc_app.yml
      loop: "{{ zitadel_setup_oidc_apps }}"
      loop_control:
        label: "{{ item.name }}"
      vars:
        zitadel_setup_current_project_id: "{{ zitadel_setup_project_id }}"
        zitadel_setup_current_app: "{{ item }}"

  post_tasks:
    - name: Show Zitadel application results
      ansible.builtin.debug:
        var: zitadel_setup_results
