---
- name: Validate OIDC application configuration
  ansible.builtin.assert:
    that:
      - zitadel_setup_current_app.name is defined
      - zitadel_setup_current_app.name | length > 0
      - zitadel_setup_current_app.redirect_uris is defined
      - zitadel_setup_current_app.redirect_uris | length > 0
    fail_msg: "Each OIDC app entry requires 'name' and at least one redirect URI."

- name: Build OIDC application payload
  ansible.builtin.set_fact:
    zitadel_current_oidc_payload:
      name: "{{ zitadel_setup_current_app.name }}"
      redirectUris: "{{ zitadel_setup_current_app.redirect_uris }}"
      responseTypes: "{{ zitadel_setup_current_app.response_types | default(['OIDC_RESPONSE_TYPE_CODE']) }}"
      grantTypes: "{{ zitadel_setup_current_app.grant_types | default(['OIDC_GRANT_TYPE_AUTHORIZATION_CODE']) }}"
      appType: "{{ zitadel_setup_current_app.app_type | default('OIDC_APP_TYPE_WEB') }}"
      authMethodType: "{{ zitadel_setup_current_app.auth_method_type | default('OIDC_AUTH_METHOD_TYPE_BASIC') }}"
      devMode: "{{ zitadel_setup_current_app.dev_mode | default(false) }}"
      accessTokenType: "{{ zitadel_setup_current_app.access_token_type | default('OIDC_TOKEN_TYPE_BEARER') }}"
      postLogoutRedirectUris: "{{ zitadel_setup_current_app.post_logout_redirect_uris | default([]) }}"
      additionalOrigins: "{{ zitadel_setup_current_app.additional_origins | default([]) }}"
      version: "{{ zitadel_setup_current_app.version | default('OIDC_VERSION_1_0') }}"
      skipNativeAppSuccessPage: "{{ zitadel_setup_current_app.skip_native_app_success_page | default(false) }}"

- name: Build normalized OIDC flags
  ansible.builtin.set_fact:
    zitadel_normalized_flags:
      devMode: "{{ zitadel_current_oidc_payload.devMode | bool }}"
      skipNativeAppSuccessPage: "{{ zitadel_current_oidc_payload.skipNativeAppSuccessPage | bool }}"

- name: Normalize OIDC payload booleans
  ansible.builtin.set_fact:
    zitadel_current_oidc_payload: "{{ zitadel_current_oidc_payload | combine(zitadel_normalized_flags) }}"

- name: Search for existing OIDC application
  ansible.builtin.uri:
    url: "{{ zitadel_setup_api_base }}/projects/{{ zitadel_setup_current_project_id }}/apps/_search"
    method: POST
    headers:
      Authorization: "Bearer {{ zitadel_setup_pat }}"
    body_format: json
    body:
      query:
        limit: 1
      queries:
        - nameQuery:
            name: "{{ zitadel_setup_current_app.name }}"
            method: "TEXT_QUERY_METHOD_EQUALS"
    status_code: 200
    validate_certs: true
  register: zitadel_current_app_search
  delegate_to: localhost

- name: Extract existing OIDC application data
  ansible.builtin.set_fact:
    zitadel_current_app_existing: "{{ (zitadel_current_app_search.json.result | default([]))[0] | default({}) }}"
    zitadel_current_app_id: "{{ (zitadel_current_app_search.json.result | default([]))[0].id | default('') }}"
    zitadel_current_app_client_id: "{{ (zitadel_current_app_search.json.result | default([]))[0].oidcConfig.clientId | default('') }}"

- name: Create OIDC application when missing
  ansible.builtin.uri:
    url: "{{ zitadel_setup_api_base }}/projects/{{ zitadel_setup_current_project_id }}/apps/oidc"
    method: POST
    headers:
      Authorization: "Bearer {{ zitadel_setup_pat }}"
    body_format: json
    body: "{{ zitadel_current_oidc_payload }}"
    status_code: 200
    validate_certs: true
  register: zitadel_current_app_create
  delegate_to: localhost
  when: zitadel_current_app_id | length == 0
  no_log: true

- name: Record created OIDC application identifiers
  ansible.builtin.set_fact:
    zitadel_current_app_id: "{{ zitadel_current_app_create.json.appId }}"
    zitadel_current_app_client_id: "{{ zitadel_current_app_create.json.clientId }}"
    zitadel_current_app_client_secret: "{{ zitadel_current_app_create.json.clientSecret }}"
  when: zitadel_current_app_create is defined

- name: Rotate OIDC client secret when requested
  ansible.builtin.uri:
    url: "{{ zitadel_setup_api_base }}/projects/{{ zitadel_setup_current_project_id }}/apps/{{ zitadel_current_app_id }}/oidc_config/_generate_client_secret"
    method: POST
    headers:
      Authorization: "Bearer {{ zitadel_setup_pat }}"
    body_format: json
    body: {}
    status_code: 200
    validate_certs: true
  register: zitadel_current_app_rotate
  delegate_to: localhost
  when:
    - zitadel_setup_current_app.rotate_secret | default(false)
    - zitadel_current_app_id | length > 0
  no_log: true

- name: Store rotated client secret
  ansible.builtin.set_fact:
    zitadel_current_app_client_secret: "{{ zitadel_current_app_rotate.json.clientSecret }}"
  when: zitadel_current_app_rotate is defined

- name: Ensure client secret fact exists
  ansible.builtin.set_fact:
    zitadel_current_app_client_secret: "{{ zitadel_current_app_client_secret | default('') }}"

- name: Update environment file with client ID
  ansible.builtin.lineinfile:
    path: "{{ zitadel_setup_current_app.env_file }}"
    regexp: "^{{ zitadel_setup_current_app.env_client_id_var | default('TRAEFIK_OAUTH_CLIENT_ID') }}="
    line: "{{ zitadel_setup_current_app.env_client_id_var | default('TRAEFIK_OAUTH_CLIENT_ID') }}={{ zitadel_current_app_client_id }}"
    create: true
    mode: '0600'
  when:
    - zitadel_setup_current_app.env_file is defined
    - zitadel_current_app_client_id | length > 0

- name: Update environment file with client secret
  ansible.builtin.lineinfile:
    path: "{{ zitadel_setup_current_app.env_file }}"
    regexp: "^{{ zitadel_setup_current_app.env_client_secret_var | default('TRAEFIK_OAUTH_CLIENT_SECRET') }}="
    line: "{{ zitadel_setup_current_app.env_client_secret_var | default('TRAEFIK_OAUTH_CLIENT_SECRET') }}={{ zitadel_current_app_client_secret }}"
    create: true
    mode: '0600'
  when:
    - zitadel_setup_current_app.env_file is defined
    - zitadel_current_app_client_secret | length > 0
  no_log: true

- name: Append Zitadel setup result
  ansible.builtin.set_fact:
    zitadel_setup_results: "{{ zitadel_setup_results + [zitadel_app_summary] }}"
  vars:
    zitadel_app_summary:
      name: "{{ zitadel_setup_current_app.name }}"
      app_id: "{{ zitadel_current_app_id }}"
      client_id: "{{ zitadel_current_app_client_id }}"
      secret_updated: "{{ ((zitadel_setup_current_app.rotate_secret | default(false)) or (zitadel_current_app_create is defined)) | bool }}"
