---
- name: Deploy all stacks
  hosts: all
  become: true
  gather_facts: false

  vars:
    stacks_src_dir: "{{ ([playbook_dir, '..', 'stacks'] | path_join) | realpath }}"
    stacks_dir: /opt/stacks
    root_project_name: stacks
    stack_state: present

  tasks:
    - name: Ensure base directories exist
      ansible.builtin.file:
        path: "{{ stacks_dir }}"
        state: directory
        mode: "0755"

    - name: Ensure rsync is available on remote host
      ansible.builtin.package:
        name: rsync
        state: present

    - name: Synchronize root stacks directory
      ansible.posix.synchronize:
        src: "{{ stacks_src_dir }}/"
        dest: "{{ stacks_dir }}/"
        delete: false
        recursive: true
        rsync_opts:
          - "--perms"
          - "--times"
          - "--omit-dir-times"
        use_ssh_args: true
        rsync_path: "sudo rsync"
      delegate_to: localhost
      become: false

    - name: Set permissions on traefik acme.json
      ansible.builtin.file:
        path: "{{ stacks_dir }}/traefik/acme.json"
        state: touch
        mode: '0600'

    - name: Create shared Docker networks
      community.docker.docker_network:
        name: "{{ item }}"
        state: present
      loop:
        - traefik
        - socket-proxy

    - name: Deploy all stacks via root orchestrator
      community.docker.docker_compose_v2:
        project_src: "{{ stacks_dir }}"
        project_name: "{{ root_project_name }}"
        state: "{{ stack_state }}"
        pull: "{{ 'always' if stack_state == 'present' else 'missing' }}"
        # Network definitions managed in docker-compose.yml
