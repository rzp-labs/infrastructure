---
- name: Deploy services stacks (Traefik + dependents)
  hosts: homelab
  become: true
  gather_facts: false

  vars:
    stacks_src_dir: "{{ ([playbook_dir, '..', 'stacks'] | path_join) | realpath }}"
    stacks_dest_dir: "/opt/stacks"
    required_networks:
      - traefik
      - socket-proxy
    bootstrap_containers:
      - docker-socket-proxy
    services_containers:
      - traefik

  tasks:
    - name: Ensure stacks directory exists on remote host
      ansible.builtin.file:
        path: "{{ stacks_dest_dir }}"
        state: directory
        mode: "0755"

    - name: Sync stacks directory (including services orchestrator) to remote host
      ansible.builtin.copy:
        src: "{{ stacks_src_dir }}/"
        dest: "{{ stacks_dest_dir }}/"
        owner: "0"
        group: "0"
        mode: preserve
      # Uses normal SSH + sudo from play (become: true)

    - name: Ensure shared networks exist for services stage
      community.docker.docker_network:
        name: "{{ item }}"
        state: present
      loop: "{{ required_networks }}"

    - name: Ensure Traefik ACME file exists with secure permissions
      ansible.builtin.file:
        path: "{{ stacks_dest_dir }}/traefik/acme.json"
        state: touch
        owner: "0"
        group: "0"
        mode: "0600"


    - name: Ensure Dozzle config directory is writable by app user
      ansible.builtin.file:
        path: "{{ stacks_dest_dir }}/dozzle/config"
        state: directory
        owner: "99"
        group: "100"
        mode: "0755"
        recurse: true

    - name: Ensure Sonarr config directory is writable by app user
      ansible.builtin.file:
        path: "{{ stacks_dest_dir }}/sonarr"
        state: directory
        owner: "99"
        group: "100"
        mode: "0755"
        recurse: true

    - name: Ensure Prowlarr config directory is writable by app user
      ansible.builtin.file:
        path: "{{ stacks_dest_dir }}/prowlarr"
        state: directory
        owner: "99"
        group: "100"
        mode: "0755"
        recurse: true

    - name: Ensure Stash directories are writable by app user
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "99"
        group: "100"
        mode: "0755"
        recurse: true
      loop:
        - "{{ stacks_dest_dir }}/stash/config"
        - "{{ stacks_dest_dir }}/stash/pip-install"
        - "{{ stacks_dest_dir }}/stash/metadata"
        - "{{ stacks_dest_dir }}/stash/cache"
        - "{{ stacks_dest_dir }}/stash/generated"

    - name: Ensure Stash Hub data directory is writable by app user
      ansible.builtin.file:
        path: "{{ stacks_dest_dir }}/stash-hub/data"
        state: directory
        owner: "99"
        group: "100"
        mode: "0755"
        recurse: true

    - name: Assert bootstrap containers are healthy before deploying services
      ansible.builtin.command: >-
        docker inspect -f '{% raw %}{{ .State.Running }}{% endraw %}' {{ item }}
      register: bootstrap_status
      changed_when: false
      failed_when: bootstrap_status.rc != 0 or (bootstrap_status.stdout | trim) != 'true'
      loop: "{{ bootstrap_containers }}"
      when: not (ansible_check_mode | default(false))

    - name: Write Molecule services orchestrator without stash stack
      ansible.builtin.copy:
        dest: "{{ stacks_dest_dir }}/docker-compose.services.molecule.yml"
        content: |
          networks:
            traefik:
              external: true
            socket-proxy:
              external: true

          include:
            - dozzle/docker-compose.yml
            - flaresolverr/docker-compose.yml
            - sonarr/docker-compose.yml
            - traefik/docker-compose.yml
        mode: "0644"
      when:
        - services_allow_fake_dri | default(false) | bool
        - not (ansible_check_mode | default(false))

    - name: Deploy services compose project (root orchestrator, full GPU)
      ansible.builtin.shell: |
        cd "{{ stacks_dest_dir }}"
        docker-compose -f docker-compose.yml up -d --remove-orphans
      args:
        executable: /bin/bash
      register: services_compose
      changed_when: services_compose.rc == 0
      failed_when: services_compose.rc != 0
      when:
        - not (services_allow_fake_dri | default(false) | bool)
        - not (docker_skip_compose | default(false))
        - not (ansible_check_mode | default(false))

    - name: Deploy services compose project for Molecule (stash excluded)
      ansible.builtin.shell: |
        cd "{{ stacks_dest_dir }}"
        docker-compose -f docker-compose.services.molecule.yml up -d --remove-orphans
      args:
        executable: /bin/bash
      register: services_compose_molecule
      changed_when: services_compose_molecule.rc == 0
      failed_when: services_compose_molecule.rc != 0
      when:
        - services_allow_fake_dri | default(false) | bool
        - not (docker_skip_compose | default(false))
        - not (ansible_check_mode | default(false))

    - name: Wait for key services containers to be running
      ansible.builtin.command: >-
        docker inspect -f '{% raw %}{{ .State.Running }}{% endraw %}' {{ item }}
      register: service_status
      changed_when: false
      until: service_status.stdout | trim == 'true'
      retries: 30
      delay: 5
      loop: "{{ services_containers }}"
      when:
        - not (ansible_check_mode | default(false))
        - not (docker_skip_compose | default(false))

    - name: Report services deployment result
      ansible.builtin.debug:
        msg: "Services stacks deployed successfully"
