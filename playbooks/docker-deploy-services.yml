---
- name: Deploy services stacks (Traefik + dependents)
  hosts: homelab
  become: true
  gather_facts: false

  vars:
    stacks_src_dir: "{{ ([playbook_dir, '..', 'stacks'] | path_join) | realpath }}"
    stacks_dest_dir: "/opt/stacks"
    required_networks:
      - traefik
      - socket-proxy
    services_containers:
      - traefik
      - sabnzbd
      - stash
      - stash-hub

  tasks:
    - name: Load GHCR credentials from .env
      ansible.builtin.set_fact:
        ghcr_user: "{{ ghcr_user | default(lookup('ini', 'GHCR_USER', type='properties', file=playbook_dir + '/../stacks/.env'), true) }}"
        ghcr_pat: "{{ ghcr_pat | default(lookup('ini', 'GHCR_PAT', type='properties', file=playbook_dir + '/../stacks/.env'), true) }}"

    - name: Debug GHCR credentials
      ansible.builtin.debug:
        msg:
          - "Playbook dir: {{ playbook_dir }}"
          - "Env file path: {{ playbook_dir + '/../stacks/.env' }}"
          - "GHCR User: {{ ghcr_user }}"
          - "GHCR PAT length: {{ ghcr_pat | length }}"

    - name: Ensure stacks directory exists on remote host
      ansible.builtin.file:
        path: "{{ stacks_dest_dir }}"
        state: directory
        mode: "0755"

    - name: Sync stacks directory (including services orchestrator) to remote host
      ansible.builtin.copy:
        src: "{{ stacks_src_dir }}/"
        dest: "{{ stacks_dest_dir }}/"
        owner: "0"
        group: "0"
        mode: preserve
      # Uses normal SSH + sudo from play (become: true)

    - name: Ensure shared networks exist for services stage
      community.docker.docker_network:
        name: "{{ item }}"
        state: present
      loop: "{{ required_networks }}"

    - name: Log in to GHCR for private images
      community.docker.docker_login:
        registry_url: ghcr.io
        username: "{{ ghcr_user }}"
        password: "{{ ghcr_pat }}"
      when: ghcr_user is defined and ghcr_pat is defined

    - name: Ensure Traefik ACME file exists with secure permissions
      ansible.builtin.file:
        path: "{{ stacks_dest_dir }}/traefik/acme.json"
        state: touch
        owner: "0"
        group: "0"
        mode: "0600"


    - name: Ensure service config directories are writable by app user
      ansible.builtin.file:
        path: "{{ stacks_dest_dir }}/{{ item }}"
        state: directory
        owner: "{{ puid }}"
        group: "{{ pgid }}"
        mode: "0755"
        recurse: false
      loop:
        - dozzle/config
        - sonarr
        - prowlarr
        - radarr
        - sabnzbd
        - nzbhydra2
        - whisparr
        - lidarr
        - fileflows/data
        - fileflows/logs
        - fileflows/tmp
        - copyparty/config
        - namer-sdb/config
        - namer-sdb/database
        - namer-sdb/logs
        - namer-pdb/config
        - namer-pdb/database
        - namer-pdb/logs
        - overseerr
        - profilarr
        - jdownloader2

    - name: Ensure Stash directories are writable by app user
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ puid }}"
        group: "{{ pgid }}"
        mode: "0755"
        recurse: true
      loop:
        - "{{ stacks_dest_dir }}/stash/config"
        - "{{ stacks_dest_dir }}/stash/pip-install"
        - "{{ stacks_dest_dir }}/stash/metadata"
        - "{{ stacks_dest_dir }}/stash/cache"
        - "{{ stacks_dest_dir }}/stash/generated"

    - name: Ensure Stash Hub directories are writable by app user
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ puid }}"
        group: "{{ pgid }}"
        mode: "0755"
        recurse: true
      loop:
        - "{{ stacks_dest_dir }}/stash-hub/data"
        - "{{ stacks_dest_dir }}/stash-hub/logs"
        - "{{ stacks_dest_dir }}/stash-hub/backend_data"
        - "{{ stacks_dest_dir }}/stash-hub/stream_endpoints"
        - "{{ stacks_dest_dir }}/stash-hub/db"

    - name: Write Molecule services orchestrator without stash stack
      ansible.builtin.copy:
        dest: "{{ stacks_dest_dir }}/docker-compose.services.molecule.yml"
        content: |
          networks:
            traefik:
              external: true
            socket-proxy:
              external: true

          include:
            - dozzle/docker-compose.yml
            - fileflows/docker-compose.yml
            - flaresolverr/docker-compose.yml
            - jdownloader2/docker-compose.yml
            - lidarr/docker-compose.yml
            - netdata/docker-compose.yml
            - nzbhydra2/docker-compose.yml
            - overseerr/docker-compose.yml
            - plex-media-server/docker-compose.yml
            - profilarr/docker-compose.yml
            - radarr/docker-compose.yml
            - sabnzbd/docker-compose.yml
            - sonarr/docker-compose.yml
            - traefik/docker-compose.yml
            - whisparr/docker-compose.yml
        mode: "0644"
      when:
        - services_allow_fake_dri | default(false) | bool
        - not (ansible_check_mode | default(false))

    - name: Load Stash Hub image from tarball
      community.docker.docker_image_load:
        path: /home/rzp-admin/the-stash-hub-latest.tar
      when:
        - not (ansible_check_mode | default(false))

    - name: Deploy services compose project (root orchestrator, full GPU)
      ansible.builtin.shell: |
        cd "{{ stacks_dest_dir }}"
        docker-compose -f docker-compose.yml up -d --remove-orphans
      args:
        executable: /bin/bash
      register: services_compose
      changed_when: services_compose.rc == 0
      failed_when: services_compose.rc != 0
      when:
        - not (services_allow_fake_dri | default(false) | bool)
        - not (docker_skip_compose | default(false))
        - not (ansible_check_mode | default(false))

    - name: Deploy services compose project for Molecule (stash excluded)
      ansible.builtin.shell: |
        cd "{{ stacks_dest_dir }}"
        docker-compose -f docker-compose.services.molecule.yml up -d --remove-orphans
      args:
        executable: /bin/bash
      register: services_compose_molecule
      changed_when: services_compose_molecule.rc == 0
      failed_when: services_compose_molecule.rc != 0
      when:
        - services_allow_fake_dri | default(false) | bool
        - not (docker_skip_compose | default(false))
        - not (ansible_check_mode | default(false))

    - name: Wait for key services containers to be running
      ansible.builtin.command: >-
        docker inspect -f '{% raw %}{{ .State.Running }}{% endraw %}' {{ item }}
      register: service_status
      changed_when: false
      until: service_status.stdout | trim == 'true'
      retries: 30
      delay: 5
      loop: "{{ services_containers }}"
      when:
        - not (ansible_check_mode | default(false))
        - not (docker_skip_compose | default(false))

    - name: Report services deployment result
      ansible.builtin.debug:
        msg: "Services stacks deployed successfully"

    - name: Configure SABnzbd to suppress warnings and handle illegal characters
      block:
        - name: Wait for SABnzbd config file to be generated
          ansible.builtin.wait_for:
            path: "{{ stacks_dest_dir }}/sabnzbd/sabnzbd.ini"
            state: present
            timeout: 300

        - name: Disable helpful_warnings in sabnzbd.ini
          ansible.builtin.lineinfile:
            path: "{{ stacks_dest_dir }}/sabnzbd/sabnzbd.ini"
            regexp: '^helpful_warnings ='
            line: 'helpful_warnings = 0'
          register: sabnzbd_warnings

        - name: Enable replace_illegal in sabnzbd.ini
          ansible.builtin.lineinfile:
            path: "{{ stacks_dest_dir }}/sabnzbd/sabnzbd.ini"
            regexp: '^replace_illegal ='
            line: 'replace_illegal = 1'
            insertafter: '\[misc\]'
          register: sabnzbd_illegal

        - name: Restart SABnzbd to apply config changes
          community.docker.docker_container:
            name: sabnzbd
            state: started
            restart: true
          when: sabnzbd_warnings.changed or sabnzbd_illegal.changed
      when:
        - "'sabnzbd' in services_containers"
        - not (ansible_check_mode | default(false))

    - name: Configure Stash-Hub connectivity
      block:
        - name: Wait for Stash config file to be generated
          ansible.builtin.wait_for:
            path: "{{ stacks_dest_dir }}/stash/config/config.yml"
            state: present
            timeout: 300

        - name: Read Stash config file
          ansible.builtin.slurp:
            src: "{{ stacks_dest_dir }}/stash/config/config.yml"
          register: stash_config_file

        - name: Extract Stash API key
          ansible.builtin.set_fact:
            stash_api_key: "{{ (stash_config_file['content'] | b64decode | from_yaml).api_key }}"

        - name: Update Stash-Hub database configuration
          ansible.builtin.shell: |
            docker exec stash-hub python3 -c "
            import sqlite3
            conn = sqlite3.connect('/app/data/main.db')
            cursor = conn.cursor()
            cursor.execute('SELECT endpoint, api_key FROM stash_config WHERE id=1')
            row = cursor.fetchone()
            if row and (row[0] != 'stash' or row[1] != '{{ stash_api_key }}'):
                cursor.execute('UPDATE stash_config SET endpoint = ?, api_key = ? WHERE id = 1', ('stash', '{{ stash_api_key }}'))
                conn.commit()
                print('changed')
            conn.close()
            "
          register: stash_hub_db_update
          changed_when: "'changed' in stash_hub_db_update.stdout"

        - name: Restart Stash-Hub to apply config changes
          community.docker.docker_container:
            name: stash-hub
            state: started
            restart: true
          when: stash_hub_db_update.changed

      when:
        - "'stash' in services_containers"
        - "'stash-hub' in services_containers"
        - not (ansible_check_mode | default(false))


