---
- name: Bootstrap homelab infrastructure with orchestrated deployment
  hosts: all
  become: true
  gather_facts: false

  vars:
    stacks_src_dir: "{{ ([playbook_dir, '..', 'stacks'] | path_join) | realpath }}"
    stacks_dir: /opt/stacks
    root_project_name: stacks
    backup_dir: /opt/stack_backups
    compose_backup_suffix: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"

  tasks:
    # ==============================================================================
    # Stage 1: Foundation - Deploy base infrastructure
    # ==============================================================================

    - name: Foundation stage | Ensure base directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ stacks_dir }}"
        - "{{ backup_dir }}"

    - name: Foundation stage | Ensure rsync is available on remote host
      ansible.builtin.package:
        name: rsync
        state: present

    - name: Foundation stage | Synchronize root stacks directory
      ansible.posix.synchronize:
        src: "{{ stacks_src_dir }}/"
        dest: "{{ stacks_dir }}/"
        delete: false
        recursive: true
        rsync_opts:
          - "--perms"
          - "--times"
          - "--omit-dir-times"
        ssh_args: >-
          -o StrictHostKeyChecking=no
          -o UserKnownHostsFile=/dev/null
          -o IdentitiesOnly=yes
          -o IdentityFile=~/.ssh/1Password/SHA256_Wsf4M9CypJTAGYY_q23s9tkxe_lLmpck3njfynuMtXo.pub
        rsync_path: "sudo rsync"
      delegate_to: localhost
      become: false

    - name: Foundation stage | Set permissions on traefik acme.json
      ansible.builtin.file:
        path: "{{ stacks_dir }}/traefik/acme.json"
        state: touch
        mode: '0600'

    - name: Foundation stage | Deploy docker-socket-proxy
      community.docker.docker_compose_v2:
        project_src: "{{ stacks_dir }}"
        project_name: "{{ root_project_name }}"
        services:
          - docker-socket-proxy
        state: present
        pull: always

    - name: Foundation stage | Ensure traefik network exists
      community.docker.docker_network:
        name: traefik
        state: present

    - name: Foundation stage | Deploy zitadel-db
      community.docker.docker_compose_v2:
        project_src: "{{ stacks_dir }}"
        project_name: "{{ root_project_name }}"
        files:
          - zitadel/docker-compose.yml
        state: present
        pull: always
        services:
          - zitadel-db

    - name: Foundation stage | Wait for Zitadel database to be ready
      ansible.builtin.shell: |
        for i in $(seq 1 30); do
          if docker exec zitadel-db pg_isready -U postgres 2>/dev/null; then
            exit 0
          fi
          sleep 2
        done
        exit 1
      register: db_ready
      changed_when: false
      retries: 3
      delay: 5
      until: db_ready.rc == 0

    - name: Foundation stage | Deploy Zitadel (bootstrap detection)
      community.docker.docker_compose_v2:
        project_src: "{{ stacks_dir }}"
        project_name: "{{ root_project_name }}"
        files:
          - zitadel/docker-compose.yml
        state: present
        pull: always
        services:
          - zitadel
      register: zitadel_deploy

    - name: Foundation stage | Wait for Zitadel login client PAT
      ansible.builtin.wait_for:
        path: "{{ stacks_dir }}/zitadel/config/login-client.pat"
        state: present
        timeout: 300
        sleep: 10
      register: zitadel_pat_wait

    - name: Foundation stage | Ensure Zitadel login client PAT is readable
      ansible.builtin.file:
        path: "{{ stacks_dir }}/zitadel/config/login-client.pat"
        mode: '0644'

    - name: Foundation stage | Wait for Zitadel health endpoint
      ansible.builtin.uri:
        url: "https://{{ lookup('env', 'ZITADEL_PUBLIC_DOMAIN') | default('auth.rzp.one') }}/healthz"
        method: GET
        validate_certs: false
        status_code: [200, 404]
      retries: 30
      delay: 5
      until: result is succeeded
      vars:
        zitadel_domain: "{{ lookup('env', 'ZITADEL_PUBLIC_DOMAIN') | default('auth.rzp.one') }}"
        result: "{{ lookup('url', 'https://' + zitadel_domain + '/healthz', validate_certs=False) | default('') }}"
      register: zitadel_health
      ignore_errors: true
      timeout: 300

    - name: Foundation stage | Set Zitadel to steady-state command
      ansible.builtin.lineinfile:
        path: "{{ stacks_dir }}/.env"
        regexp: '^ZITADEL_COMMAND='
        line: 'ZITADEL_COMMAND=start'
        mode: '0600'
      when: zitadel_pat_wait is succeeded

    # ==============================================================================
    # Stage 2: OAuth Setup - Create Traefik OAuth application in Zitadel
    # ==============================================================================

    - name: OAuth setup | Read Zitadel login client PAT
      ansible.builtin.slurp:
        path: "{{ stacks_dir }}/zitadel/config/login-client.pat"
      register: zitadel_pat_slurp

    - name: OAuth setup | Store Zitadel login client PAT value
      ansible.builtin.set_fact:
        zitadel_login_pat: "{{ zitadel_pat_slurp.content | b64decode | trim }}"
      no_log: true

    # Note: Console V2 API feature flag is set via environment variable in docker-compose.yml
    # (ZITADEL_DEFAULTINSTANCE_FEATURES_CONSOLEUSEV2USERAPI=true)
    # This applies to new instances. For existing instances, enable via console UI at:
    # https://login.rzp.one/ui/console/instance?id=features

    - name: OAuth setup | Create Traefik OAuth application
      ansible.builtin.include_role:
        name: "{{ lookup('first_found', {'files': ['zitadel_setup'], 'paths': ['roles']}) }}"
        tasks_from: "manage_oidc_app"
      vars:
        zitadel_setup_api_base: "https://{{ lookup('env', 'ZITADEL_PUBLIC_DOMAIN') | default('auth.rzp.one') }}/management/v1"
        zitadel_setup_pat: "{{ zitadel_login_pat }}"
        zitadel_setup_project_id: "{{ zitadel_project_id }}"
        zitadel_setup_current_app:
          name: "Traefik OAuth2 Proxy"
          redirect_uris:
            - "https://traefik.{{ lookup('env', 'DOMAIN') | default('rzp.one') }}/oauth2/callback"
          post_logout_redirect_uris:
            - "https://traefik.{{ lookup('env', 'DOMAIN') | default('rzp.one') }}"
          env_file: "{{ stacks_dir }}/traefik/.env"
          env_client_id_var: "TRAEFIK_OAUTH_CLIENT_ID"
          env_client_secret_var: "TRAEFIK_OAUTH_CLIENT_SECRET"
        zitadel_setup_current_project_id: "{{ zitadel_project_id }}"
      register: traefik_oauth_app
      no_log: true
      ignore_errors: true

    - name: OAuth setup | Fetch Zitadel project ID (alternative approach)
      ansible.builtin.shell: |
        set -a
        . "{{ stacks_dir }}/zitadel/.env"
        printf "%s" "$ZITADEL_PROJECT_NAME"
      args:
        executable: /bin/bash
      register: zitadel_project_name_cmd
      changed_when: false
      when: traefik_oauth_app is failed

    - name: OAuth setup | Set fallback project name
      ansible.builtin.set_fact:
        zitadel_project_id: "{{ lookup('env', 'ZITADEL_PROJECT_NAME') | default('Default Project') }}"

    # ==============================================================================
    # Stage 3: Proxy Layer - Deploy Traefik and OAuth2 proxy
    # ==============================================================================

    - name: Proxy stage | Generate OAuth2 cookie secret
      ansible.builtin.command: python3 -c 'import os,base64; print(base64.urlsafe_b64encode(os.urandom(32)).decode())'
      register: cookie_secret
      changed_when: false

    - name: Proxy stage | Save OAuth2 cookie secret to .env
      ansible.builtin.lineinfile:
        path: "{{ stacks_dir }}/traefik/.env"
        regexp: '^OAUTH2_PROXY_COOKIE_SECRET='
        line: "OAUTH2_PROXY_COOKIE_SECRET={{ cookie_secret.stdout }}"
        create: true
        mode: "0600"

    - name: Proxy stage | Ensure zitadel network exists
      community.docker.docker_network:
        name: zitadel
        internal: true
        state: present

    - name: Proxy stage | Deploy Traefik with OAuth
      community.docker.docker_compose_v2:
        project_src: "{{ stacks_dir }}"
        project_name: "{{ root_project_name }}"
        services:
          - traefik
          - traefik-oauth2-proxy
        state: present
        pull: always

    - name: Proxy stage | Wait for Traefik to be ready
      ansible.builtin.wait_for:
        port: 8443
        delay: 5
        timeout: 60
        state: started

    - name: Proxy stage | Verify Traefik is responding
      ansible.builtin.uri:
        url: "http://localhost:8080/ping"
        method: GET
        status_code: 200
      retries: 20
      delay: 2
      register: traefik_health
      until: traefik_health is succeeded

    # ==============================================================================
    # Stage 4: Services - Deploy remaining services
    # ==============================================================================

    - name: Services stage | Deploy remaining stacks
      community.docker.docker_compose_v2:
        project_src: "{{ stacks_dir }}"
        project_name: "{{ root_project_name }}"
        state: present
        pull: always

    - name: Services stage | Wait for services to stabilize
      ansible.builtin.pause:
        seconds: 10

    - name: Services stage | Record bootstrap completion
      ansible.builtin.debug:
        msg: "Bootstrap completed successfully"
