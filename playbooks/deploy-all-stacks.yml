---
- name: Deploy all stacks
  hosts: all
  become: true
  gather_facts: false

  vars:
    stacks_src_dir: "../stacks"
    stacks_dir: /opt/stacks
    backup_dir: /opt/stack_backups
    compose_backup_suffix: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"
    stacks:
      - docker-socket-proxy
      - traefik

  tasks:
    - name: Ensure stack and backup directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ stacks_dir }}"
        - "{{ backup_dir }}"

    - name: Create stack directories
      ansible.builtin.file:
        path: "{{ stacks_dir }}/{{ item }}"
        state: directory
        mode: '0755'
      loop: "{{ stacks }}"

    - name: Copy stack files from local to remote
      ansible.builtin.copy:
        src: "{{ stacks_src_dir }}/{{ item }}/"
        dest: "{{ stacks_dir }}/{{ item }}/"
        mode: preserve
      loop: "{{ stacks }}"

    - name: Create proxy network
      community.docker.docker_network:
        name: proxy
        state: present

    - name: Set permissions on acme.json for traefik
      ansible.builtin.file:
        path: "{{ stacks_dir }}/traefik/acme.json"
        state: touch
        mode: '0600'
      when: "'traefik' in stacks"

    - name: Back up current Compose files before deploy
      community.general.archive:
        path: "{{ stacks_dir }}"
        dest: "{{ backup_dir }}/compose_backup_{{ compose_backup_suffix }}.tar.gz"
        format: gz
        mode: "0644"
      register: backup_result
      changed_when: backup_result.dest is defined
      failed_when: backup_result.failed is defined and backup_result.failed

    - name: Deploy all stacks with Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ stacks_dir }}/{{ item }}"
        state: present
        pull: "always"
      loop: "{{ stacks }}"
      register: deploy_results
