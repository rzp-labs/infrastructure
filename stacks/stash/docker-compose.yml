---
services:
  stash:
    container_name: stash
    image: ghcr.io/feederbox826/stash-s6:hwaccel-develop
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9999/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - traefik
    devices:
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/nas/data:/data
      - /opt/stacks/stash/config:/config
      - /opt/stacks/stash/pip-install:/pip-install
      - /opt/stacks/stash/metadata:/metadata
      - /opt/stacks/stash/cache:/cache
      - /opt/stacks/stash/generated:/generated
      # Optional: Custom certificate path (uncomment if needed)
      # - /path/to/custom/certs:/config/certs:ro

      # Optional: Migration paths (uncomment if migrating from old installations)
      # - /path/to/old/stashapp/config:/root/.stash  # For stashapp/stash migration
      # - /path/to/old/hotio/config:/config/.stash   # For hotio/stash migration
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
      - MIGRATE=FALSE
      - SKIP_NVIDIA_PATCH=FALSE
      - CUSTOM_CERT_PATH=/config/certs
      # - AVGID=18
      # - LIBVA_DRIVER_NAME_JELLYFIN=iHD
      # - LIBVA_DRIVER_NAME=iHD
      - STASH_METADATA=/metadata/
      - STASH_CACHE=/cache/
      - STASH_GENERATED=/generated/
      - STASH_STASH=/data/
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.stash.entrypoints=websecure"
      - "traefik.http.routers.stash.middlewares=internal@file,secure-headers@file"
      - "traefik.http.routers.stash.tls.certresolver=cloudflare"
      - "traefik.http.routers.stash.rule=Host(`stash.${DOMAIN}`)"
      - "traefik.http.services.stash.loadbalancer.server.port=9999"

networks:
  traefik:
    external: true
